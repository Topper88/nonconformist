<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ð¿ o Ð¿ c o Ð¿ f o r m i s t | The Circle of Destiny v1.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:'Courier New',monospace; }
  #info { position:absolute; top:20px; left:20px; color:#ddd; background:rgba(0,0,0,0.6); padding:15px; border-radius:12px; max-width:340px; backdrop-filter:blur(10px); z-index:10; border:1px solid #334; }
  #info a { color:#8cf; }
  .tooltip { position:absolute; background:rgba(20,20,40,0.95); color:#fff; padding:10px 16px; border-radius:10px; font-size:14px; pointer-events:none; opacity:0; transition:opacity .3s; z-index:100; backdrop-filter:blur(12px); border:1px solid #556; }
  .album-panel { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(15,15,35,0.5); color:#fff; padding:30px; border-radius:20px; width:380px; box-shadow:0 0 60px rgba(100,180,255,0.5); display:none; z-index:200; backdrop-filter:blur(16px); border:1px solid #667; }
  .close-btn { position:absolute; top:12px; right:16px; font-size:28px; cursor:pointer; color:#aaa; z-index:300; }
  .close-btn:hover { color:#fff; }
  #cc { position:absolute; bottom:20px; right:20px; color:#666; font-size:11px; z-index:10; }
  #cc a { color:#8cf; text-decoration:none; }
  #player-bubble { position:absolute; bottom:30px; right:30px; width:60px; height:60px; background:rgba(100,180,255,0.7); border-radius:50%; cursor:pointer; z-index:150; text-align:center; line-height:60px; font-size:32px; color:#fff; backdrop-filter:blur(10px); border:2px solid #88ccff; box-shadow:0 0 20px rgba(100,180,255,0.6); display:none; transition:transform 0.2s; }
  #player-bubble:hover { background:rgba(100,180,255,0.9); transform:scale(1.1); }

  /* Dice Modal â€” Beautiful Design */
  #dice-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
    z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s;
  }
  #dice-modal.active { visibility: visible; opacity: 1; }
  .dice-container {
    background: #fdfffc; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    padding: 40px; max-width: 500px; width: 90%; text-align: center; position: relative;
  }
  .dice-container h1 {
    color: #011627; margin: 0 0 30px 0; font-size: 28px;
  }
  #dice-rollButton {
    background: #2ec4b6; color: #fdfffc; border: none; padding: 15px 40px;
    font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer;
    transition: all 0.2s; box-shadow: 0 4px 15px rgba(46,196,182,0.4);
  }
  #dice-rollButton:hover {
    transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46,196,182,0.6); background: #26a89c;
  }
  #dice-result {
    min-height: 100px; display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px;
  }
  .dice-result-box {
    padding: 20px 30px; color: #fdfffc; border-radius: 15px; font-weight: bold; font-size: 32px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); min-width: 100px; animation: fadeIn 0.3s ease-in;
  }
  .dice-result-box:nth-child(1) { background: #e71d36; }
  .dice-result-box:nth-child(2) { background: #ff9f1c; }
  .dice-label { font-size: 14px; opacity: 0.9; display: block; margin-bottom: 8px; }
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }
  #fate-result {
    margin-top: 30px; font-size: 22px; color: #011627;
  }
  #fate-result span {
    text-decoration: underline; cursor: pointer; color: #2ec4b6;
  }
  #fate-result span:hover {
    color: #26a89c;
  }
</style>
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

  window.onload = () => {
    // Main Scene (unchanged)
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x0a1a2f, 0.0008);
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    scene.background = new THREE.Color(0x0a0a1f);
    const stars = new THREE.Points(
      new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(Array.from({length:9000},()=>THREE.MathUtils.randFloatSpread(2000)),3)),
      new THREE.PointsMaterial({color:0xffffff,size:1.2})
    );
    scene.add(stars);

    scene.add(new THREE.AmbientLight(0x404060, 0.9));
    const moon = new THREE.DirectionalLight(0xaaccff, 1.4);
    moon.position.set(30,50,20);
    scene.add(moon);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(800,800), new THREE.MeshStandardMaterial({color:0x0a1a0a, roughness:1}));
    ground.rotation.x = -Math.PI/2;
    ground.position.y = -1;
    scene.add(ground);

    // Stonehenge (unchanged)
    const stonehenge = new THREE.Group();
    stonehenge.userData.type = 'stonehenge';
    const stoneMat = new THREE.MeshStandardMaterial({color:0x777777, roughness:0.95});
    const left = new THREE.Mesh(new THREE.BoxGeometry(3,12,3), stoneMat);
    left.position.set(-6,6,0);
    left.userData.type = 'stonehenge';
    const right = new THREE.Mesh(new THREE.BoxGeometry(3,12,3), stoneMat);
    right.position.set(6,6,0);
    right.userData.type = 'stonehenge';
    const lintel = new THREE.Mesh(new THREE.BoxGeometry(15,3,3.5), stoneMat);
    lintel.position.set(0,13,0);
    lintel.userData.type = 'stonehenge';
    stonehenge.add(left,right,lintel);

    const aura = new THREE.Mesh(new THREE.SphereGeometry(12,32,16), new THREE.MeshBasicMaterial({color:0x88ccff, transparent:true, opacity:0.2}));
    aura.position.y = 7;
    stonehenge.add(aura);
    scene.add(stonehenge);

    // Orbit Controls (unchanged)
    let radius = 70;
    let theta = 0;
    let phi = Math.PI / 3.5;
    let isDragging = false;
    let previousMouse = { x: 0, y: 0 };
    let gameMode = false;
    let targetRadius = 70;
    let targetPhi = Math.PI / 3.5;

    const updateCamera = () => {
      camera.position.x = radius * Math.sin(phi) * Math.cos(theta);
      camera.position.y = radius * Math.cos(phi);
      camera.position.z = radius * Math.sin(phi) * Math.sin(theta);
      camera.lookAt(0, 6, 0);
    };
    updateCamera();

    // ... (mouse controls unchanged)

    // FRUIT SHAPES, TRACK TITLES, ALBUMS â€” unchanged
    // (all the arrays and albums data remain exactly the same)

    // Build Trees, Fruits, Chests â€” unchanged

    // Background forest â€” unchanged

    // Dice Game
    const diceModal = document.getElementById('dice-modal');
    const diceRollButton = document.getElementById('dice-rollButton');
    const diceResult = document.getElementById('dice-result');
    const fateResult = document.getElementById('fate-result');

    let lastChosenUrl = '';
    let lastChosenTitle = '';
    let lastChosenArt = '';
    let autoPlayed = false;  // <<< NEW FLAG

    function rollDice() {
      const result8 = Math.floor(Math.random() * 8) + 1;
      const result12 = Math.floor(Math.random() * 12) + 1;

      diceResult.innerHTML = `
        <div class="dice-result-box">
          <span class="dice-label">D8</span>
          ${result8}
        </div>
        <div class="dice-result-box">
          <span class="dice-label">D12</span>
          ${result12}
        </div>
      `;

      const albumIndex = result8 - 1;
      const trackIndex = result12 - 1;
      const chosenAlbum = albums[albumIndex];
      const chosenTrackTitle = trackTitles[albumPrefixes[albumIndex]][trackIndex];

      lastChosenUrl = chosenAlbum.tracks[trackIndex];
      lastChosenTitle = chosenTrackTitle;
      lastChosenArt = chosenAlbum.art;

      fateResult.innerHTML = `<span>Fate chose: ${chosenAlbum.title} â€” ${chosenTrackTitle}</span>`;
      fateResult.onclick = () => {
        diceModal.classList.remove('active');
        gameMode = false;
        targetRadius = 70;
        targetPhi = Math.PI / 3.5;
        loadTrack(lastChosenUrl, lastChosenTitle, lastChosenArt);
      };

      autoPlayed = true;  // <<< Mark that we auto-started a track

      // Auto open player after roll
      loadTrack(lastChosenUrl, lastChosenTitle, lastChosenArt);
    }

    diceRollButton.addEventListener('click', rollDice);

    // Interaction â€” unchanged (raycaster, tooltip, etc.)

    // Player
    const playerBubble = document.getElementById('player-bubble');
    playerBubble.onclick = () => {
      const panel = document.getElementById('album-panel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    };

    function loadTrack(url, title, art) {
      document.getElementById('album-title').textContent = title;
      document.getElementById('album-art').src = art;
      document.getElementById('player-container').innerHTML = `<iframe width="100%" height="450" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${url}&color=%235ab&auto_play=true"></iframe>`;
      document.getElementById('album-panel').style.display = 'block';
      playerBubble.style.display = 'block';
    }

    // Click handling â€” unchanged

    // <<< FIXED CLOSE BUTTON HANDLER >>>
    document.querySelectorAll('.close-btn').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        
        // Only hide the player panel if it was NOT opened by the dice auto-play
        if (!autoPlayed) {
          document.getElementById('album-panel').style.display = 'none';
        }
        
        diceModal.classList.remove('active');
        gameMode = false;
        targetRadius = 70;
        targetPhi = Math.PI / 3.5;
        
        autoPlayed = false;  // Reset flag
      };
    });

    // Resize â€” unchanged

    // Animation loop â€” unchanged
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const t = clock.getElapsedTime();

      radius += (targetRadius - radius) * 0.05;
      phi += (targetPhi - phi) * 0.05;
      updateCamera();

      const pulse = 1 + Math.sin(t * 1.2) * 0.04;
      stonehenge.scale.setScalar(pulse);
      aura.material.opacity = 0.2 + Math.sin(t * 1.5) * 0.1;

      renderer.render(scene, camera);
    }
    animate();
  };
</script>
</head>
<body>
<!-- All HTML body content remains exactly the same -->
<div id="info">
  <strong>Ð¿ o Ð¿ c o Ð¿ f o r m i s t</strong><br>
  <em>The Circle of Destiny v1.2</em><br><br>
  Drag to orbit â€¢ Scroll to zoom<br>
  Click Stonehenge â†’ roll the Dice of Fate<br>
  Hover chests/fruits â†’ see titles<br>
  Click fate result â†’ play chosen song<br>
  â™ª bubble = toggle player<br>
  <a href="https://ko-fi.com/n_nconformist" target="_blank">Tip if it moves you</a>
</div>
<div class="tooltip" id="tooltip"></div>
<div id="cc">
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a>
  <span style="margin-left:20px; color:#888;">Dice Game Design by Claude â€¢ Forest & Destiny by Grok</span>
</div>

<div id="album-panel" class="album-panel">
  <div class="close-btn">Ã—</div>
  <h3 id="album-title"></h3>
  <img id="album-art" width="100%" style="border-radius:12px; margin:16px 0;">
  <div id="player-container"></div>
</div>

<div id="player-bubble">â™ª</div>

<div id="dice-modal">
  <div class="dice-container">
    <div class="close-btn">Ã—</div>
    <h1>ðŸŽ² Dice Rolling Game ðŸŽ²</h1>
    <div style="text-align:center; margin-bottom:30px;">
      <button id="dice-rollButton">Roll Dice!</button>
    </div>
    <div id="dice-result"></div>
    <div id="fate-result">Roll to let fate choose your song...</div>
  </div>
</div>
</body>
</html>
