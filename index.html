<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>п o п c o п f o r m i s t | The Circle of Destiny v0.8</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:'Courier New',monospace; }
  #info { position:absolute; top:20px; left:20px; color:#ddd; background:rgba(0,0,0,0.6); padding:15px; border-radius:12px; max-width:340px; backdrop-filter:blur(10px); z-index:10; border:1px solid #334; }
  #info a { color:#8cf; }
  .tooltip { position:absolute; background:rgba(20,20,40,0.95); color:#fff; padding:10px 16px; border-radius:10px; font-size:14px; pointer-events:none; opacity:0; transition:opacity .3s; z-index:100; backdrop-filter:blur(12px); border:1px solid #556; }
  .album-panel { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(15,15,35,0.5); color:#fff; padding:30px; border-radius:20px; width:380px; box-shadow:0 0 60px rgba(100,180,255,0.5); display:none; z-index:200; backdrop-filter:blur(16px); border:1px solid #667; }
  .close-btn { position:absolute; top:12px; right:16px; font-size:28px; cursor:pointer; color:#aaa; }
  .close-btn:hover { color:#fff; }
  #cc { position:absolute; bottom:20px; right:20px; color:#666; font-size:11px; z-index:10; }
  #cc a { color:#8cf; text-decoration:none; }
  #player-bubble { position:absolute; bottom:30px; right:30px; width:60px; height:60px; background:rgba(100,180,255,0.7); border-radius:50%; cursor:pointer; z-index:150; text-align:center; line-height:60px; font-size:32px; color:#fff; backdrop-filter:blur(10px); border:2px solid #88ccff; box-shadow:0 0 20px rgba(100,180,255,0.6); display:none; transition:transform 0.2s; }
  #player-bubble:hover { background:rgba(100,180,255,0.9); transform:scale(1.1); }

  /* Dice Modal */
  #dice-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
    z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s;
  }
  #dice-modal.active { visibility: visible; opacity: 1; }
  .modal-content {
    background: #16213e; width: 90%; max-width: 900px; height: 600px; border-radius: 16px;
    overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  #canvas-container { flex-grow: 1; background: #0f1b2e; }
  .ui-panel {
    height: 100px; background: #1a2a44; display: flex; align-items: center; justify-content: space-between; padding: 0 40px;
  }
  #result-display { font-size: 28px; font-weight: bold; color: #88ccff; }
  #roll-btn {
    background: #ff4757; color: white; border: none; padding: 16px 40px; font-size: 20px; border-radius: 30px;
    cursor: pointer; transition: transform 0.1s; font-weight: bold;
  }
  #roll-btn:active { transform: scale(0.95); }
  #roll-btn:disabled { background: #666; cursor: not-allowed; }
</style>
<script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
    "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
  }
}
</script>
</head>
<body>

<div id="info">
  <strong>п o п c o п f o r m i s t</strong><br>
  <em>The Circle of Destiny v0.8</em><br><br>
  Drag to orbit • Scroll to zoom<br>
  Click Stonehenge → roll the Dice of Fate<br>
  Click chest/fruit → play<br>
  ♪ bubble = toggle player<br>
  <a href="https://ko-fi.com/nnconformist" target="_blank">Tip if it moves you</a>
</div>
<div class="tooltip" id="tooltip"></div>
<div id="cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></div>

<div id="album-panel" class="album-panel">
  <div class="close-btn">×</div>
  <h3 id="album-title"></h3>
  <img id="album-art" width="100%" style="border-radius:12px; margin:16px 0;">
  <div id="player-container"></div>
</div>

<div id="player-bubble">♪</div>

<!-- Dice Game Modal -->
<div id="dice-modal">
  <div class="modal-content">
    <div class="close-btn">×</div>
    <div id="canvas-container"></div>
    <div class="ui-panel">
      <div id="result-display">Result: <span id="score-text">-</span></div>
      <button id="roll-btn">ROLL DICE</button>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from 'three';
  import * as CANNON from 'cannon-es';

  // Main Scene Setup
  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x0a1a2f, 0.0008);
  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  scene.background = new THREE.Color(0x0a0a1f);
  const stars = new THREE.Points(
    new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(Array.from({length:9000},()=>THREE.MathUtils.randFloatSpread(2000)),3)),
    new THREE.PointsMaterial({color:0xffffff,size:1.2})
  );
  scene.add(stars);

  scene.add(new THREE.AmbientLight(0x404060, 0.9));
  const moon = new THREE.DirectionalLight(0xaaccff, 1.4);
  moon.position.set(30,50,20);
  scene.add(moon);

  const ground = new THREE.Mesh(new THREE.PlaneGeometry(800,800), new THREE.MeshStandardMaterial({color:0x0a1a0a, roughness:1}));
  ground.rotation.x = -Math.PI/2;
  ground.position.y = -1;
  scene.add(ground);

  // Stonehenge (clickable)
  const stonehenge = new THREE.Group();
  stonehenge.userData.type = 'stonehenge';
  const stoneMat = new THREE.MeshStandardMaterial({color:0x777777, roughness:0.95});
  const left = new THREE.Mesh(new THREE.BoxGeometry(3,12,3), stoneMat);
  left.position.set(-6,6,0);
  const right = new THREE.Mesh(new THREE.BoxGeometry(3,12,3), stoneMat);
  right.position.set(6,6,0);
  const lintel = new THREE.Mesh(new THREE.BoxGeometry(15,3,3.5), stoneMat);
  lintel.position.set(0,13,0);
  stonehenge.add(left,right,lintel);

  const aura = new THREE.Mesh(new THREE.SphereGeometry(12,32,16), new THREE.MeshBasicMaterial({color:0x88ccff, transparent:true, opacity:0.2}));
  aura.position.y = 7;
  stonehenge.add(aura);
  scene.add(stonehenge);

  // Orbit Controls
  let radius = 70;
  let theta = 0;
  let phi = Math.PI / 3.5;
  let isDragging = false;
  let previousMouse = { x: 0, y: 0 };
  let gameMode = false;
  let targetRadius = 70;
  let targetPhi = Math.PI / 3.5;

  const updateCamera = () => {
    camera.position.x = radius * Math.sin(phi) * Math.cos(theta);
    camera.position.y = radius * Math.cos(phi);
    camera.position.z = radius * Math.sin(phi) * Math.sin(theta);
    camera.lookAt(0, 6, 0);
  };
  updateCamera();

  renderer.domElement.addEventListener('pointerdown', e => isDragging = true);
  renderer.domElement.addEventListener('pointermove', e => {
    if (isDragging && !gameMode) {
      const deltaX = e.clientX - previousMouse.x;
      const deltaY = e.clientY - previousMouse.y;
      theta -= deltaX * 0.005;
      phi += deltaY * 0.005;
      phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi));
      previousMouse = { x: e.clientX, y: e.clientY };
      updateCamera();
    }
  });
  renderer.domElement.addEventListener('pointerup', () => isDragging = false);
  renderer.domElement.addEventListener('wheel', e => {
    radius += e.deltaY * 0.05;
    radius = Math.max(30, Math.min(150, radius));
    updateCamera();
  });

  // Albums
  const albums = [
    {playlist: "https://soundcloud.com/musique_residentielle/sets/wisdom-box", tracks: ["https://soundcloud.com/musique_residentielle/wb_01","https://soundcloud.com/musique_residentielle/wb_02","https://soundcloud.com/musique_residentielle/wb_03","https://soundcloud.com/musique_residentielle/wb_04","https://soundcloud.com/musique_residentielle/wb_05","https://soundcloud.com/musique_residentielle/wb_06","https://soundcloud.com/musique_residentielle/wb_07","https://soundcloud.com/musique_residentielle/wb_08","https://soundcloud.com/musique_residentielle/wb_09","https://soundcloud.com/musique_residentielle/wb_10","https://soundcloud.com/musique_residentielle/wb_11","https://soundcloud.com/musique_residentielle/wb_12"], title: "Wisdom Box", art: "https://i1.sndcdn.com/artworks-000683927318-7p1r5t-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/energy-box", tracks: ["https://soundcloud.com/musique_residentielle/eb_01","https://soundcloud.com/musique_residentielle/eb_02","https://soundcloud.com/musique_residentielle/eb_03","https://soundcloud.com/musique_residentielle/eb_04","https://soundcloud.com/musique_residentielle/eb_05","https://soundcloud.com/musique_residentielle/eb_06","https://soundcloud.com/musique_residentielle/eb_07","https://soundcloud.com/musique_residentielle/eb_08","https://soundcloud.com/musique_residentielle/eb_09","https://soundcloud.com/musique_residentielle/eb_10","https://soundcloud.com/musique_residentielle/eb_11","https://soundcloud.com/musique_residentielle/eb_12"], title: "Energy Box", art: "https://i1.sndcdn.com/artworks-000683427258-1t6u3w-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/mystery-box", tracks: ["https://soundcloud.com/musique_residentielle/mb_01","https://soundcloud.com/musique_residentielle/mb_02","https://soundcloud.com/musique_residentielle/mb_03","https://soundcloud.com/musique_residentielle/mb_04","https://soundcloud.com/musique_residentielle/mb_05","https://soundcloud.com/musique_residentielle/mb_06","https://soundcloud.com/musique_residentielle/mb_07","https://soundcloud.com/musique_residentielle/mb_08","https://soundcloud.com/musique_residentielle/mb_09","https://soundcloud.com/musique_residentielle/mb_10","https://soundcloud.com/musique_residentielle/mb_11","https://soundcloud.com/musique_residentielle/mb_12"], title: "Mystery Box", art: "https://i1.sndcdn.com/artworks-000683827306-0p2q3s-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/optima-box", tracks: ["https://soundcloud.com/musique_residentielle/ob_01","https://soundcloud.com/musique_residentielle/ob_02","https://soundcloud.com/musique_residentielle/ob_03","https://soundcloud.com/musique_residentielle/ob_04","https://soundcloud.com/musique_residentielle/ob_05","https://soundcloud.com/musique_residentielle/ob_06","https://soundcloud.com/musique_residentielle/ob_07","https://soundcloud.com/musique_residentielle/ob_08","https://soundcloud.com/musique_residentielle/ob_09","https://soundcloud.com/musique_residentielle/ob_10","https://soundcloud.com/musique_residentielle/ob_11","https://soundcloud.com/musique_residentielle/ob_12"], title: "Optima Box", art: "https://i1.sndcdn.com/artworks-000684027330-5v4q3t-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/therapy-box", tracks: ["https://soundcloud.com/musique_residentielle/tb_01","https://soundcloud.com/musique_residentielle/tb_02","https://soundcloud.com/musique_residentielle/tb_03","https://soundcloud.com/musique_residentielle/tb_04","https://soundcloud.com/musique_residentielle/tb_05","https://soundcloud.com/musique_residentielle/tb_06","https://soundcloud.com/musique_residentielle/tb_07","https://soundcloud.com/musique_residentielle/tb_08","https://soundcloud.com/musique_residentielle/tb_09","https://soundcloud.com/musique_residentielle/tb_10","https://soundcloud.com/musique_residentielle/tb_11","https://soundcloud.com/musique_residentielle/tb_12"], title: "Therapy Box", art: "https://i1.sndcdn.com/artworks-000683627282-9r4s1u-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/romantic-box", tracks: ["https://soundcloud.com/musique_residentielle/rb_01","https://soundcloud.com/musique_residentielle/rb_02","https://soundcloud.com/musique_residentielle/rb_03","https://soundcloud.com/musique_residentielle/rb_04","https://soundcloud.com/musique_residentielle/rb_05","https://soundcloud.com/musique_residentielle/rb_06","https://soundcloud.com/musique_residentielle/rb_07","https://soundcloud.com/musique_residentielle/rb_08","https://soundcloud.com/musique_residentielle/rb_09","https://soundcloud.com/musique_residentielle/rb_10","https://soundcloud.com/musique_residentielle/rb_11","https://soundcloud.com/musique_residentielle/rb_12"], title: "Romantic Box", art: "https://i1.sndcdn.com/artworks-000683727294-8q3r2t-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/fiesta-box", tracks: ["https://soundcloud.com/musique_residentielle/fb_01","https://soundcloud.com/musique_residentielle/fb_02","https://soundcloud.com/musique_residentielle/fb_03","https://soundcloud.com/musique_residentielle/fb_04","https://soundcloud.com/musique_residentielle/fb_05","https://soundcloud.com/musique_residentielle/fb_06","https://soundcloud.com/musique_residentielle/fb_07","https://soundcloud.com/musique_residentielle/fb_08","https://soundcloud.com/musique_residentielle/fb_09","https://soundcloud.com/musique_residentielle/fb_10","https://soundcloud.com/musique_residentielle/fb_11","https://soundcloud.com/musique_residentielle/fb_12"], title: "Fiesta Box", art: "https://i1.sndcdn.com/artworks-000683527270-0s5t2v-t500x500.jpg"},
    {playlist: "https://soundcloud.com/musique_residentielle/sets/bonus-box", tracks: ["https://soundcloud.com/musique_residentielle/bb_01","https://soundcloud.com/musique_residentielle/bb_02","https://soundcloud.com/musique_residentielle/bb_03","https://soundcloud.com/musique_residentielle/bb_04","https://soundcloud.com/musique_residentielle/bb_05","https://soundcloud.com/musique_residentielle/bb_06","https://soundcloud.com/musique_residentielle/bb_07","https://soundcloud.com/musique_residentielle/bb_08","https://soundcloud.com/musique_residentielle/bb_09","https://soundcloud.com/musique_residentielle/bb_10","https://soundcloud.com/musique_residentielle/bb_11","https://soundcloud.com/musique_residentielle/bb_12"], title: "Bonus Box", art: "https://i1.sndcdn.com/artworks-000684027330-5v4q3t-t500x500.jpg"}
  ];

  const radiusCircle = 34;
  const fruits = [];

  albums.forEach((album,i)=>{
    const angle = (i/albums.length)*Math.PI*2;
    const x = Math.cos(angle)*radiusCircle;
    const z = Math.sin(angle)*radiusCircle;

    // Tree
    const tree = new THREE.Group();
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1.6,2.2,17,8), new THREE.MeshStandardMaterial({color:0x3d2817}));
    trunk.position.y = 8.5;
    const leaves = new THREE.Mesh(new THREE.SphereGeometry(7.5,10,8), new THREE.MeshStandardMaterial({color:0x0a2a0a}));
    leaves.position.y = 17;
    tree.add(trunk,leaves);
    tree.position.set(x,0,z);
    scene.add(tree);

    // 12 Fruits
    for(let f=0; f<12; f++){
      const shape = fruitShapes[Math.floor(Math.random()*fruitShapes.length)];
      const color = fruitColors[Math.floor(Math.random()*fruitColors.length)];
      const fruit = new THREE.Mesh(shape, new THREE.MeshStandardMaterial({color, emissive:color, emissiveIntensity:0.6}));
      const thetaF = Math.random()*Math.PI*2;
      const phiF = Math.acos(2*Math.random() - 1);
      const r = 7.5;
      fruit.position.set(r * Math.sin(phiF) * Math.cos(thetaF), 17 + (Math.cos(phiF) * r), r * Math.sin(phiF) * Math.sin(thetaF));
      fruit.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
      fruit.scale.setScalar(0.5 + Math.random()*0.3);
      fruit.userData = {type:'fruit', url: album.tracks[f], albumIndex: i, trackIndex: f};
      tree.add(fruit);
      fruits.push(fruit);
    }

    // Chest
    const chestX = x - Math.cos(angle)*5;
    const chestZ = z - Math.sin(angle)*5;
    const chest = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(3.2,2,2.4), new THREE.MeshStandardMaterial({color:0x8B4513}));
    const lid = new THREE.Mesh(new THREE.BoxGeometry(3.3,0.5,2.5), new THREE.MeshStandardMaterial({color:0xA0522D}));
    lid.position.y = 1.25;
    chest.add(body,lid);

    const canvas = document.createElement('canvas'); canvas.width=canvas.height=256;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle='#8B0000'; ctx.fillRect(0,0,256,256);
    ctx.strokeStyle='#FFD700'; ctx.lineWidth=24;
    ctx.strokeRect(18,18,220,220); ctx.strokeRect(48,48,160,160);
    ctx.font='bold 146px Arial'; ctx.fillStyle='#FFD700'; ctx.textAlign='center'; ctx.fillText('П',128,182);
    const tex = new THREE.CanvasTexture(canvas);
    const panel = new THREE.Mesh(new THREE.PlaneGeometry(2.6,1.6), new THREE.MeshStandardMaterial({map:tex, emissive:0xff3366, emissiveIntensity:0.4}));
    panel.position.set(0,0.6,1.21);
    chest.add(panel);

    chest.position.set(chestX,0,chestZ);
    chest.lookAt(0,0,0);
    chest.userData = {type:'chest', url: album.playlist, album};
    scene.add(chest);
  });

  // Background forest
  for(let i=0;i<250;i++){
    const a = Math.random()*Math.PI*2;
    const d = 80 + Math.random()*400;
    const tree = new THREE.Group();
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1,1.6,14,8), new THREE.MeshStandardMaterial({color:0x3d2817}));
    trunk.position.y = 7;
    const leaves = new THREE.Mesh(new THREE.SphereGeometry(6,8,6), new THREE.MeshStandardMaterial({color:0x0a2a0a}));
    leaves.position.y = 14;
    tree.add(trunk,leaves);
    tree.position.set(Math.cos(a)*d,0,Math.sin(a)*d);
    scene.add(tree);
  }

  // Interaction
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  const tooltip = document.getElementById('tooltip');
  let hovered = null;

  window.addEventListener('pointermove', e=>{
    mouse.x = (e.clientX/innerWidth)*2-1;
    mouse.y = -(e.clientY/innerHeight)*2+1;
    raycaster.setFromCamera(mouse,camera);
    const hits = raycaster.intersectObjects(scene.children,true);
    let found = null;
    for(let h of hits){
      if(h.object.parent?.userData?.type === 'stonehenge'){
        tooltip.textContent = 'Click to roll the Dice of Fate';
        tooltip.style.opacity = 1;
        break;
      }
      if(h.object.userData && h.object.userData.type==='fruit'){
        found = h.object; break;
      }
      if(h.object.parent && h.object.parent.userData && h.object.parent.userData.type==='chest'){
        found = h.object.parent; break;
      }
    }
    if(found!==hovered){
      if(hovered) hovered.scale.set(1,1,1);
      hovered = found;
      if(hovered && hovered.userData.type !== 'stonehenge'){
        hovered.scale.set(1.15,1.15,1.15);
        tooltip.textContent = hovered.userData.type === 'fruit' ? hovered.userData.album.title + ' Track' : hovered.userData.album.title;
        tooltip.style.left = (e.clientX+15)+'px';
        tooltip.style.top = (e.clientY+15)+'px';
        tooltip.style.opacity = 1;
      } else if (!hovered) tooltip.style.opacity = 0;
    }
  });

  // Player
  let lastUrl = '';
  let lastTitle = '';
  let lastArt = '';

  const playerBubble = document.getElementById('player-bubble');
  playerBubble.onclick = () => {
    const panel = document.getElementById('album-panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  };

  function loadTrack(url, title, art) {
    lastUrl = url;
    lastTitle = title;
    lastArt = art;
    document.getElementById('album-title').textContent = title;
    document.getElementById('album-art').src = art;
    document.getElementById('player-container').innerHTML = `<iframe width="100%" height="450" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${url}&color=%235ab&auto_play=true"></iframe>`;
    document.getElementById('album-panel').style.display = 'block';
    playerBubble.style.display = 'block';
  }

  window.addEventListener('click',()=>{ if(hovered){
    if(hovered.userData.type === 'stonehenge'){
      gameMode = true;
      targetRadius = 25;
      targetPhi = Math.PI / 4;
      document.getElementById('dice-modal').classList.add('active');
    } else {
      const type = hovered.userData.type;
      const url = hovered.userData.url || hovered.userData.album.playlist;
      const title = type === 'fruit' ? 'Track' : hovered.userData.album.title;
      const art = hovered.userData.album?.art || '';
      loadTrack(url, title, art);
    }
  }});

  document.querySelectorAll('.close-btn').forEach(btn => btn.onclick = () => {
    document.getElementById('album-panel').style.display = 'none';
    document.getElementById('dice-modal').classList.remove('active');
    gameMode = false;
    targetRadius = 70;
    targetPhi = Math.PI / 3.5;
  });

  // Dice Game (Gemini's code integrated)
  const diceModal = document.getElementById('dice-modal');
  const diceContainer = document.getElementById('canvas-container');
  const rollBtn = document.getElementById('roll-btn');
  const scoreText = document.getElementById('score-text');

  const diceScene = new THREE.Scene();
  const diceCamera = new THREE.PerspectiveCamera(45, diceContainer.clientWidth / diceContainer.clientHeight, 0.1, 100);
  diceCamera.position.set(0, 15, 10);
  diceCamera.lookAt(0, 0, 0);

  const diceRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  diceRenderer.setSize(diceContainer.clientWidth, diceContainer.clientHeight);
  diceRenderer.shadowMap.enabled = true;
  diceContainer.appendChild(diceRenderer.domElement);

  const ambient = new THREE.AmbientLight(0xffffff, 0.5);
  diceScene.add(ambient);
  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(5, 20, 10);
  dirLight.castShadow = true;
  diceScene.add(dirLight);

  const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -39.24, 0) });
  const floorMaterial = new CANNON.Material('floor');
  const diceMaterial = new CANNON.Material('dice');
  world.addContactMaterial(new CANNON.ContactMaterial(floorMaterial, diceMaterial, { friction: 0.1, restitution: 0.5 }));

  const floorBody = new CANNON.Body({ type: CANNON.Body.STATIC, shape: new CANNON.Plane(), material: floorMaterial });
  floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
  world.addBody(floorBody);

  const floorMesh = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.ShadowMaterial({ opacity: 0.3 }));
  floorMesh.rotation.x = -Math.PI / 2;
  floorMesh.receiveShadow = true;
  diceScene.add(floorMesh);

  const diceObjects = [];
  function createDice(type, position, color) {
    let geometry = type === 'd8' ? new THREE.OctahedronGeometry(1) : new THREE.DodecahedronGeometry(1);
    const material = new THREE.MeshStandardMaterial({ color, roughness: 0.2, metalness: 0.1, flatShading: true });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.castShadow = true;
    diceScene.add(mesh);

    const shape = type === 'd8' ? new CANNON.Box(new CANNON.Vec3(1,1,1)) : new CANNON.Box(new CANNON.Vec3(1,1,1)); // Approximation for rolling
    const body = new CANNON.Body({ mass: 1, shape, position: new CANNON.Vec3(...position), material: diceMaterial });
    world.addBody(body);

    return { mesh, body, type, faces: type === 'd8' ? 8 : 12 };
  }

  const d8 = createDice('d8', [-2, 5, 0], 0xff4757);
  const d12 = createDice('d12', [2, 5, 0], 0x1e90ff);
  diceObjects.push(d8, d12);

  let isRolling = false;

  function rollDice() {
    if(isRolling) return;
    isRolling = true;
    rollBtn.disabled = true;
    scoreText.innerText = "...";

    diceObjects.forEach(d => {
      d.body.position.set(d.type === 'd8' ? -2 : 2, 5, 0);
      d.body.velocity.set(0, 0, 0);
      d.body.angularVelocity.set(0, 0, 0);

      const force = 60 + Math.random() * 30;
      const randX = (Math.random() - 0.5) * 10;
      const randZ = (Math.random() - 0.5) * 10;
      d.body.applyImpulse(new CANNON.Vec3(randX, force, randZ), new CANNON.Vec3(0, 0, 0));
      d.body.angularVelocity.set(Math.random() * 30 - 15, Math.random() * 30 - 15, Math.random() * 30 - 15);
    });
  }

  function checkStopped() {
    if (!isRolling) return;
    let allStopped = true;
    diceObjects.forEach(d => {
      if (d.body.velocity.length() > 0.1 || d.body.angularVelocity.length() > 0.1) allStopped = false;
    });
    if (allStopped) {
      setTimeout(() => {
        const d8Result = Math.floor(Math.random() * 8); // 0-7
        const d12Result = Math.floor(Math.random() * 12); // 0-11
        scoreText.innerText = `${albums[d8Result].title} — Track ${d12Result + 1}`;
        loadTrack(albums[d8Result].tracks[d12Result], `Fate chose: ${albums[d8Result].title} Track ${d12Result + 1}`, albums[d8Result].art);
        isRolling = false;
        rollBtn.disabled = false;
      }, 300);
    }
  }

  rollBtn.addEventListener('click', rollDice);

  const diceClock = new THREE.Clock();
  function diceAnimate() {
    requestAnimationFrame(diceAnimate);
    if (diceModal.classList.contains('active')) {
      world.step(1/60);
      diceObjects.forEach(d => {
        d.mesh.position.copy(d.body.position);
        d.mesh.quaternion.copy(d.body.quaternion);
      });
      checkStopped();
      diceRenderer.render(diceScene, diceCamera);
    }
  }
  diceAnimate();

  window.addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
    if (diceModal.classList.contains('active')) {
      diceCamera.aspect = diceContainer.clientWidth / diceContainer.clientHeight;
      diceCamera.updateProjectionMatrix();
      diceRenderer.setSize(diceContainer.clientWidth, diceContainer.clientHeight);
    }
  });

  // Main Animation
  const clock = new THREE.Clock();
  function animate() {
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();

    radius += (targetRadius - radius) * 0.05;
    phi += (targetPhi - phi) * 0.05;
    updateCamera();

    const pulse = 1 + Math.sin(t * 1.2) * 0.04;
    stonehenge.scale.setScalar(pulse);
    aura.material.opacity = 0.2 + Math.sin(t * 1.5) * 0.1;

    renderer.render(scene, camera);
  }
  animate();
</script>
</body>
</html>
