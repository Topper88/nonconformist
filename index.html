<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>п o п c o п f o r m i s t | The Circle of Destiny v1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:'Courier New',monospace; }
  #info { position:absolute; top:20px; left:20px; color:#ddd; background:rgba(0,0,0,0.6); padding:15px; border-radius:12px; max-width:340px; backdrop-filter:blur(10px); z-index:10; border:1px solid #334; }
  #info a { color:#8cf; }
  .tooltip { position:absolute; background:rgba(20,20,40,0.95); color:#fff; padding:10px 16px; border-radius:10px; font-size:14px; pointer-events:none; opacity:0; transition:opacity .3s; z-index:100; backdrop-filter:blur(12px); border:1px solid #556; }
  .album-panel { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(15,15,35,0.5); color:#fff; padding:30px; border-radius:20px; width:380px; box-shadow:0 0 60px rgba(100,180,255,0.5); display:none; z-index:200; backdrop-filter:blur(16px); border:1px solid #667; }
  .close-btn { position:absolute; top:12px; right:16px; font-size:28px; cursor:pointer; color:#aaa; z-index:300; }
  .close-btn:hover { color:#fff; }
  #cc { position:absolute; bottom:20px; right:20px; color:#666; font-size:11px; z-index:10; }
  #cc a { color:#8cf; text-decoration:none; }
  #player-bubble { position:absolute; bottom:30px; right:30px; width:60px; height:60px; background:rgba(100,180,255,0.7); border-radius:50%; cursor:pointer; z-index:150; text-align:center; line-height:60px; font-size:32px; color:#fff; backdrop-filter:blur(10px); border:2px solid #88ccff; box-shadow:0 0 20px rgba(100,180,255,0.6); display:none; transition:transform 0.2s; }
  #player-bubble:hover { background:rgba(100,180,255,0.9); transform:scale(1.1); }

  /* Dice Modal */
  #dice-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
    z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s;
  }
  #dice-modal.active { visibility: visible; opacity: 1; }
  .modal-content {
    background: #16213e; width: 90%; max-width: 900px; height: 600px; border-radius: 16px;
    overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  #canvas-container { flex-grow: 1; background: #0f1b2e; }
  .ui-panel {
    height: 100px; background: #1a2a44; display: flex; align-items: center; justify-content: space-between; padding: 0 40px;
  }
  #result-display { font-size: 24px; font-weight: bold; color: #88ccff; cursor:pointer; }
  #result-display span { text-decoration:underline; }
  #roll-btn {
    background: #ff4757; color: white; border: none; padding: 16px 40px; font-size: 20px; border-radius: 30px;
    cursor: pointer; transition: transform 0.1s; font-weight: bold;
  }
  #roll-btn:active { transform: scale(0.95); }
  #roll-btn:disabled { background: #666; cursor: not-allowed; }
</style>
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

  window.onload = () => {
    // Main Scene
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x0a1a2f, 0.0008);
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    scene.background = new THREE.Color(0x0a0a1f);
    const stars = new THREE.Points(
      new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(Array.from({length:9000},()=>THREE.MathUtils.randFloatSpread(2000)),3)),
      new THREE.PointsMaterial({color:0xffffff,size:1.2})
    );
    scene.add(stars);

    scene.add(new THREE.AmbientLight(0x404060, 0.9));
    const moon = new THREE.DirectionalLight(0xaaccff, 1.4);
    moon.position.set(30,50,20);
    scene.add(moon);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(800,800), new THREE.MeshStandardMaterial({color:0x0a1a0a, roughness:1}));
    ground.rotation.x = -Math.PI/2;
    ground.position.y = -1;
    scene.add(ground);

    // Stonehenge
    const stonehenge = new THREE.Group();
    stonehenge.userData.type = 'stonehenge';
    const stoneMat = new THREE.MeshStandardMaterial({color:0x777777, roughness:0.95});
    const left = new THREE.Mesh(new THREE.BoxGeometry(3,12,3), stoneMat);
    left.position.set(-6,6,0);
    left.userData.type = 'stonehenge';
    const right = new THREE.Mesh(new THREE.BoxGeometry(3,12,3), stoneMat);
    right.position.set(6,6,0);
    right.userData.type = 'stonehenge';
    const lintel = new THREE.Mesh(new THREE.BoxGeometry(15,3,3.5), stoneMat);
    lintel.position.set(0,13,0);
    lintel.userData.type = 'stonehenge';
    stonehenge.add(left,right,lintel);

    const aura = new THREE.Mesh(new THREE.SphereGeometry(12,32,16), new THREE.MeshBasicMaterial({color:0x88ccff, transparent:true, opacity:0.2}));
    aura.position.y = 7;
    stonehenge.add(aura);
    scene.add(stonehenge);

    // Orbit Controls
    let radius = 70;
    let theta = 0;
    let phi = Math.PI / 3.5;
    let isDragging = false;
    let previousMouse = { x: 0, y: 0 };
    let gameMode = false;
    let targetRadius = 70;
    let targetPhi = Math.PI / 3.5;

    const updateCamera = () => {
      camera.position.x = radius * Math.sin(phi) * Math.cos(theta);
      camera.position.y = radius * Math.cos(phi);
      camera.position.z = radius * Math.sin(phi) * Math.sin(theta);
      camera.lookAt(0, 6, 0);
    };
    updateCamera();

    renderer.domElement.addEventListener('pointerdown', e => isDragging = true);
    renderer.domElement.addEventListener('pointermove', e => {
      if (isDragging && !gameMode) {
        const deltaX = e.clientX - previousMouse.x;
        const deltaY = e.clientY - previousMouse.y;
        theta -= deltaX * 0.005;
        phi += deltaY * 0.005;
        phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi));
        previousMouse = { x: e.clientX, y: e.clientY };
        updateCamera();
      }
    });
    renderer.domElement.addEventListener('pointerup', () => isDragging = false);
    renderer.domElement.addEventListener('wheel', e => {
      radius += e.deltaY * 0.05;
      radius = Math.max(30, Math.min(150, radius));
      updateCamera();
    });

    // FRUIT SHAPES AND COLORS
    const fruitShapes = [
      new THREE.SphereGeometry(0.6, 8, 6),
      new THREE.SphereGeometry(0.7, 10, 8),
      new THREE.ConeGeometry(0.5, 1.2, 8),
      new THREE.ConeGeometry(0.4, 1.4, 8),
      new THREE.BoxGeometry(0.7, 1.1, 0.7),
      new THREE.TorusGeometry(0.4, 0.15, 6, 12)
    ];
    const fruitColors = [0xff3366, 0x33ff99, 0xffaa00, 0xcc33ff, 0xffff33, 0x33ccff, 0xff6666, 0x66ff33, 0xff33cc, 0x33ff66, 0x66ccff, 0xccff33];

    // Track Titles
    const trackTitles = {
      wb: ["Discovery","Connection Found v1","Connection Found v2","Walls to Climb v1","Walls to Climb v2","As We Learn Cycling v1","As We Learn Cycling v2","As We Learn Cycling v3","Forgiving the Necessary Evil v1","Forgiving the Necessary Evil v2","Unfolded Consequences v1","Unfolded Consequences v2"],
      eb: ["Embrace the Magic","Embrace More Magic","No Matter What v2","No Matter What v1","No Matter What v3","Time Is Here v0.2","Time Is Here v1","Time Is Here v2","Rotten Suggestion","Stand My Ground v0","Stand My Ground v2","Stand My Ground v1"],
      mb: ["It Has Always Been There","Revelation","Haunting Paradigms v1","Haunting Paradigms v2","Haunting Paradigms v3","Distant Murmur of Tribal Uprisings v1","Distant Murmur of Tribal Uprisings v2","Distant Murmur of Tribal Uprisings v3","Undisclosed Meaning v1","Undisclosed Meaning v2","Undisclosed Meaning v3","Undisclosed Meaning (Extended)"],
      ob: ["The Future Is Inviting","Intrigued v1","Intrigued v2","Feedforward v2","Feedforward v1.3","Sparks of Ingenuity v1","Sparks of Ingenuity v2","The Future Is Still Inviting v1","The Future Is Still Inviting v2","To Be Continued v1","To Be Continued v2","To Be Continued v3"],
      tb: ["Hello Mailer-Daemon v2","Hello Mailer-Daemon v1","Crushhour v2","Crushhour v1","Beyond the Moment Lost v1","Beyond the Moment Lost v3","Beyond the Moment Lost v2","Lurking Memories v1","Lurking Memories v2","Exported Whispers v1","Exported Whispers v2","Exported Whispers v3"],
      rb: ["Premature Farewell v3","Premature Farewell v1","Premature Farewell v2","Holding What Matters v1","Holding What Matters v2","Holding What Matters v3","Holding What Matters v4","Pointing Fingers v1","Pointing Fingers v2","Murky Waters v2","Murky Waters v3","Murky Waters v1"],
      fb: ["Come Well v1","Come Well v2","Come Well v3","Euphoria v3.1","Euphoria v2","Euphoria v1","Fruity Outcome v2","Fruity Outcome v3","Fruity Outcome v1","Wedding March v2","Wedding March v3","Wedding March v1"],
      bb: ["Sharp on Time","The Catalyst","Move On v1","Move On v2","For the Financial Alchemists v1","For the Financial Alchemists v2","For the Financial Alchemists v3","Shepherd’s Tale v1","Shepherd’s Tale v3","Shepherd’s Tale v2","Shepherd’s Tale v4","Halloween Special"]
    };

    const albumPrefixes = ['wb','eb','mb','ob','tb','rb','fb','bb'];

    // ALBUMS
    const albums = [
      {playlist: "https://soundcloud.com/musique_residentielle/sets/wisdom-box", tracks: ["https://soundcloud.com/musique_residentielle/wb_01","https://soundcloud.com/musique_residentielle/wb_02","https://soundcloud.com/musique_residentielle/wb_03","https://soundcloud.com/musique_residentielle/wb_04","https://soundcloud.com/musique_residentielle/wb_05","https://soundcloud.com/musique_residentielle/wb_06","https://soundcloud.com/musique_residentielle/wb_07","https://soundcloud.com/musique_residentielle/wb_08","https://soundcloud.com/musique_residentielle/wb_09","https://soundcloud.com/musique_residentielle/wb_10","https://soundcloud.com/musique_residentielle/wb_11","https://soundcloud.com/musique_residentielle/wb_12"], title: "Wisdom Box", art: "https://i1.sndcdn.com/artworks-000683927318-7p1r5t-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/energy-box", tracks: ["https://soundcloud.com/musique_residentielle/eb_01","https://soundcloud.com/musique_residentielle/eb_02","https://soundcloud.com/musique_residentielle/eb_03","https://soundcloud.com/musique_residentielle/eb_04","https://soundcloud.com/musique_residentielle/eb_05","https://soundcloud.com/musique_residentielle/eb_06","https://soundcloud.com/musique_residentielle/eb_07","https://soundcloud.com/musique_residentielle/eb_08","https://soundcloud.com/musique_residentielle/eb_09","https://soundcloud.com/musique_residentielle/eb_10","https://soundcloud.com/musique_residentielle/eb_11","https://soundcloud.com/musique_residentielle/eb_12"], title: "Energy Box", art: "https://i1.sndcdn.com/artworks-000683427258-1t6u3w-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/mystery-box", tracks: ["https://soundcloud.com/musique_residentielle/mb_01","https://soundcloud.com/musique_residentielle/mb_02","https://soundcloud.com/musique_residentielle/mb_03","https://soundcloud.com/musique_residentielle/mb_04","https://soundcloud.com/musique_residentielle/mb_05","https://soundcloud.com/musique_residentielle/mb_06","https://soundcloud.com/musique_residentielle/mb_07","https://soundcloud.com/musique_residentielle/mb_08","https://soundcloud.com/musique_residentielle/mb_09","https://soundcloud.com/musique_residentielle/mb_10","https://soundcloud.com/musique_residentielle/mb_11","https://soundcloud.com/musique_residentielle/mb_12"], title: "Mystery Box", art: "https://i1.sndcdn.com/artworks-000683827306-0p2q3s-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/optima-box", tracks: ["https://soundcloud.com/musique_residentielle/ob_01","https://soundcloud.com/musique_residentielle/ob_02","https://soundcloud.com/musique_residentielle/ob_03","https://soundcloud.com/musique_residentielle/ob_04","https://soundcloud.com/musique_residentielle/ob_05","https://soundcloud.com/musique_residentielle/ob_06","https://soundcloud.com/musique_residentielle/ob_07","https://soundcloud.com/musique_residentielle/ob_08","https://soundcloud.com/musique_residentielle/ob_09","https://soundcloud.com/musique_residentielle/ob_10","https://soundcloud.com/musique_residentielle/ob_11","https://soundcloud.com/musique_residentielle/ob_12"], title: "Optima Box", art: "https://i1.sndcdn.com/artworks-000684027330-5v4q3t-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/therapy-box", tracks: ["https://soundcloud.com/musique_residentielle/tb_01","https://soundcloud.com/musique_residentielle/tb_02","https://soundcloud.com/musique_residentielle/tb_03","https://soundcloud.com/musique_residentielle/tb_04","https://soundcloud.com/musique_residentielle/tb_05","https://soundcloud.com/musique_residentielle/tb_06","https://soundcloud.com/musique_residentielle/tb_07","https://soundcloud.com/musique_residentielle/tb_08","https://soundcloud.com/musique_residentielle/tb_09","https://soundcloud.com/musique_residentielle/tb_10","https://soundcloud.com/musique_residentielle/tb_11","https://soundcloud.com/musique_residentielle/tb_12"], title: "Therapy Box", art: "https://i1.sndcdn.com/artworks-000683627282-9r4s1u-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/romantic-box", tracks: ["https://soundcloud.com/musique_residentielle/rb_01","https://soundcloud.com/musique_residentielle/rb_02","https://soundcloud.com/musique_residentielle/rb_03","https://soundcloud.com/musique_residentielle/rb_04","https://soundcloud.com/musique_residentielle/rb_05","https://soundcloud.com/musique_residentielle/rb_06","https://soundcloud.com/musique_residentielle/rb_07","https://soundcloud.com/musique_residentielle/rb_08","https://soundcloud.com/musique_residentielle/rb_09","https://soundcloud.com/musique_residentielle/rb_10","https://soundcloud.com/musique_residentielle/rb_11","https://soundcloud.com/musique_residentielle/rb_12"], title: "Romantic Box", art: "https://i1.sndcdn.com/artworks-000683727294-8q3r2t-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/fiesta-box", tracks: ["https://soundcloud.com/musique_residentielle/fb_01","https://soundcloud.com/musique_residentielle/fb_02","https://soundcloud.com/musique_residentielle/fb_03","https://soundcloud.com/musique_residentielle/fb_04","https://soundcloud.com/musique_residentielle/fb_05","https://soundcloud.com/musique_residentielle/fb_06","https://soundcloud.com/musique_residentielle/fb_07","https://soundcloud.com/musique_residentielle/fb_08","https://soundcloud.com/musique_residentielle/fb_09","https://soundcloud.com/musique_residentielle/fb_10","https://soundcloud.com/musique_residentielle/fb_11","https://soundcloud.com/musique_residentielle/fb_12"], title: "Fiesta Box", art: "https://i1.sndcdn.com/artworks-000683527270-0s5t2v-t500x500.jpg"},
      {playlist: "https://soundcloud.com/musique_residentielle/sets/bonus-box", tracks: ["https://soundcloud.com/musique_residentielle/bb_01","https://soundcloud.com/musique_residentielle/bb_02","https://soundcloud.com/musique_residentielle/bb_03","https://soundcloud.com/musique_residentielle/bb_04","https://soundcloud.com/musique_residentielle/bb_05","https://soundcloud.com/musique_residentielle/bb_06","https://soundcloud.com/musique_residentielle/bb_07","https://soundcloud.com/musique_residentielle/bb_08","https://soundcloud.com/musique_residentielle/bb_09","https://soundcloud.com/musique_residentielle/bb_10","https://soundcloud.com/musique_residentielle/bb_11","https://soundcloud.com/musique_residentielle/bb_12"], title: "Bonus Box", art: "https://i1.sndcdn.com/artworks-000684027330-5v4q3t-t500x500.jpg"}
    ];

    // Build Trees, Fruits, Chests
    const radiusCircle = 34;
    albums.forEach((album,i)=>{
      const angle = (i/albums.length)*Math.PI*2;
      const x = Math.cos(angle)*radiusCircle;
      const z = Math.sin(angle)*radiusCircle;

      const tree = new THREE.Group();
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1.6,2.2,17,8), new THREE.MeshStandardMaterial({color:0x3d2817}));
      trunk.position.y = 8.5;
      const leaves = new THREE.Mesh(new THREE.SphereGeometry(7.5,10,8), new THREE.MeshStandardMaterial({color:0x0a2a0a}));
      leaves.position.y = 17;
      tree.add(trunk,leaves);
      tree.position.set(x,0,z);
      scene.add(tree);

      const prefix = albumPrefixes[i];
      for(let f=0; f<12; f++){
        const shape = fruitShapes[Math.floor(Math.random()*fruitShapes.length)];
        const color = fruitColors[Math.floor(Math.random()*fruitColors.length)];
        const fruit = new THREE.Mesh(shape, new THREE.MeshStandardMaterial({color, emissive:color, emissiveIntensity:0.6}));
        const thetaF = Math.random()*Math.PI*2;
        const phiF = Math.acos(2*Math.random() - 1);
        const r = 7.5;
        fruit.position.set(r * Math.sin(phiF) * Math.cos(thetaF), 17 + (Math.cos(phiF) * r), r * Math.sin(phiF) * Math.sin(thetaF));
        fruit.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
        fruit.scale.setScalar(0.5 + Math.random()*0.3);
        fruit.userData = {type:'fruit', url: album.tracks[f], trackTitle: trackTitles[prefix][f]};
        tree.add(fruit);
      }

      const chestX = x - Math.cos(angle)*5;
      const chestZ = z - Math.sin(angle)*5;
      const chest = new THREE.Group();
      const body = new THREE.Mesh(new THREE.BoxGeometry(3.2,2,2.4), new THREE.MeshStandardMaterial({color:0x8B4513}));
      const lid = new THREE.Mesh(new THREE.BoxGeometry(3.3,0.5,2.5), new THREE.MeshStandardMaterial({color:0xA0522D}));
      lid.position.y = 1.25;
      chest.add(body,lid);

      const canvas = document.createElement('canvas'); canvas.width=canvas.height=256;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle='#8B0000'; ctx.fillRect(0,0,256,256);
      ctx.strokeStyle='#FFD700'; ctx.lineWidth=24;
      ctx.strokeRect(18,18,220,220); ctx.strokeRect(48,48,160,160);
      ctx.font='bold 146px Arial'; ctx.fillStyle='#FFD700'; ctx.textAlign='center'; ctx.fillText('П',128,182);
      const tex = new THREE.CanvasTexture(canvas);
      const panel = new THREE.Mesh(new THREE.PlaneGeometry(2.6,1.6), new THREE.MeshStandardMaterial({map:tex, emissive:0xff3366, emissiveIntensity:0.4}));
      panel.position.set(0,0.6,1.21);
      chest.add(panel);

      chest.position.set(chestX,0,chestZ);
      chest.lookAt(0,0,0);
      chest.userData = {type:'chest', url: album.playlist, albumTitle: album.title};
      scene.add(chest);
    });

    // Background forest
    for(let i=0;i<250;i++){
      const a = Math.random()*Math.PI*2;
      const d = 80 + Math.random()*400;
      const tree = new THREE.Group();
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(1,1.6,14,8), new THREE.MeshStandardMaterial({color:0x3d2817}));
      trunk.position.y = 7;
      const leaves = new THREE.Mesh(new THREE.SphereGeometry(6,8,6), new THREE.MeshStandardMaterial({color:0x0a2a0a}));
      leaves.position.y = 14;
      tree.add(trunk,leaves);
      tree.position.set(Math.cos(a)*d,0,Math.sin(a)*d);
      scene.add(tree);
    }

    // Dice Modal
    const diceModal = document.getElementById('dice-modal');
    const diceContainer = document.getElementById('canvas-container');
    const rollBtn = document.getElementById('roll-btn');
    const resultDisplay = document.getElementById('result-display');

    const diceScene = new THREE.Scene();
    const diceCamera = new THREE.PerspectiveCamera(45, diceContainer.clientWidth / diceContainer.clientHeight, 0.1, 100);
    diceCamera.position.set(0, 15, 10);
    diceCamera.lookAt(0, 0, 0);

    const diceRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    diceRenderer.setSize(diceContainer.clientWidth, diceContainer.clientHeight);
    diceRenderer.shadowMap.enabled = true;
    diceContainer.appendChild(diceRenderer.domElement);

    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    diceScene.add(ambient);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(5, 20, 10);
    dirLight.castShadow = true;
    diceScene.add(dirLight);

    const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -39.24, 0) });
    const floorMaterial = new CANNON.Material('floor');
    const diceMaterial = new CANNON.Material('dice');
    world.addContactMaterial(new CANNON.ContactMaterial(floorMaterial, diceMaterial, { friction: 0.1, restitution: 0.5 }));

    const floorBody = new CANNON.Body({ type: CANNON.Body.STATIC, shape: new CANNON.Plane(), material: floorMaterial });
    floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    world.addBody(floorBody);

    // Invisible walls to keep dice in view
    const wallSize = 10;
    const wallThickness = 0.5;
    const wallHeight = 5;
    const wallMat = new CANNON.Material('wall');
    const walls = [
      new CANNON.Box(new CANNON.Vec3(wallSize, wallHeight, wallThickness)), // front
      new CANNON.Box(new CANNON.Vec3(wallSize, wallHeight, wallThickness)), // back
      new CANNON.Box(new CANNON.Vec3(wallThickness, wallHeight, wallSize)), // left
      new CANNON.Box(new CANNON.Vec3(wallThickness, wallHeight, wallSize))  // right
    ];
    walls.forEach((shape, i) => {
      const body = new CANNON.Body({ type: CANNON.Body.STATIC, shape, material: wallMat });
      if (i === 0) body.position.set(0, wallHeight/2, wallSize);
      if (i === 1) body.position.set(0, wallHeight/2, -wallSize);
      if (i === 2) body.position.set(-wallSize, wallHeight/2, 0);
      if (i === 3) body.position.set(wallSize, wallHeight/2, 0);
      world.addBody(body);
    });

    const floorMesh = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.ShadowMaterial({ opacity: 0.3 }));
    floorMesh.rotation.x = -Math.PI / 2;
    floorMesh.receiveShadow = true;
    diceScene.add(floorMesh);

    // Dice with numbers
    function createNumberedDice(type, position, color) {
      const geometry = type === 'd8' ? new THREE.OctahedronGeometry(1) : new THREE.DodecahedronGeometry(1);
      const material = new THREE.MeshStandardMaterial({ color, roughness: 0.2, metalness: 0.1 });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.castShadow = true;
      diceScene.add(mesh);

      // Add numbers
      const canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 256;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,256,256);
      ctx.font = 'bold 140px Arial';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      const faces = type === 'd8' ? 8 : 12;
      const loader = new THREE.TextureLoader();
      const numbers = Array.from({length: faces}, (_, i) => i + 1);
      numbers.forEach((num, i) => {
        ctx.clearRect(0,0,256,256);
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,256,256);
        ctx.fillStyle = '#fff';
        ctx.fillText(num.toString(), 128, 128);
        const texture = new THREE.CanvasTexture(canvas);
        const faceMat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, opacity: 0.8 });
        const faceGeo = new THREE.PlaneGeometry(1.4, 1.4);
        const faceMesh = new THREE.Mesh(faceGeo, faceMat);
        const normal = geometry.attributes.normal.array.slice(i*9, i*9+3);
        const normalVec = new THREE.Vector3(normal[0], normal[1], normal[2]).normalize();
        faceMesh.position.copy(normalVec.clone().multiplyScalar(1.01));
        faceMesh.lookAt(normalVec.multiplyScalar(2));
        mesh.add(faceMesh);
      });

      const shape = new CANNON.Box(new CANNON.Vec3(1,1,1));
      const body = new CANNON.Body({ mass: 1, shape, position: new CANNON.Vec3(...position), material: diceMaterial });
      world.addBody(body);

      return { mesh, body, type };
    }

    const d8 = createNumberedDice('d8', [-2, 5, 0], 0xff4757);
    const d12 = createNumberedDice('d12', [2, 5, 0], 0x1e90ff);
    const diceObjects = [d8, d12];

    let isRolling = false;
    let lastChosenUrl = '';
    let lastChosenTitle = '';
    let lastChosenArt = '';

    function rollDice() {
      if(isRolling) return;
      isRolling = true;
      rollBtn.disabled = true;
      resultDisplay.innerHTML = 'Rolling...';

      diceObjects.forEach(d => {
        d.body.position.set(d.type === 'd8' ? -2 : 2, 5, 0);
        d.body.velocity.set(0, 0, 0);
        d.body.angularVelocity.set(0, 0, 0);

        const force = 60 + Math.random() * 30;
        const randX = (Math.random() - 0.5) * 8;
        const randZ = (Math.random() - 0.5) * 8;
        d.body.applyImpulse(new CANNON.Vec3(randX, force, randZ), new CANNON.Vec3(0, 0, 0));
        d.body.angularVelocity.set(Math.random() * 30 - 15, Math.random() * 30 - 15, Math.random() * 30 - 15);
      });
    }

    function checkStopped() {
      if (!isRolling) return;
      let allStopped = true;
      diceObjects.forEach(d => {
        if (d.body.velocity.length() > 0.1 || d.body.angularVelocity.length() > 0.1) allStopped = false;
      });
      if (allStopped) {
        setTimeout(() => {
          const d8Result = Math.floor(Math.random() * 8);
          const d12Result = Math.floor(Math.random() * 12);
          const chosenAlbum = albums[d8Result];
          const chosenTrackTitle = trackTitles[albumPrefixes[d8Result]][d12Result];
          const url = chosenAlbum.tracks[d12Result];
          const art = chosenAlbum.art;

          lastChosenUrl = url;
          lastChosenTitle = chosenTrackTitle;
          lastChosenArt = art;

          resultDisplay.innerHTML = `<span style="cursor:pointer; text-decoration:underline;">${chosenAlbum.title} — ${chosenTrackTitle}</span>`;
          resultDisplay.onclick = () => loadTrack(url, chosenTrackTitle, art);

          loadTrack(url, chosenTrackTitle, art);
          isRolling = false;
          rollBtn.disabled = false;
        }, 300);
      }
    }

    rollBtn.addEventListener('click', rollDice);

    function diceAnimate() {
      requestAnimationFrame(diceAnimate);
      if (diceModal.classList.contains('active')) {
        world.step(1/60);
        diceObjects.forEach(d => {
          d.mesh.position.copy(d.body.position);
          d.mesh.quaternion.copy(d.body.quaternion);
        });
        checkStopped();
        diceRenderer.render(diceScene, diceCamera);
      }
    }
    diceAnimate();

    function resizeDiceCanvas() {
      if (diceModal.classList.contains('active') && diceContainer) {
        const width = diceContainer.clientWidth;
        const height = diceContainer.clientHeight;
        diceCamera.aspect = width / height;
        diceCamera.updateProjectionMatrix();
        diceRenderer.setSize(width, height);
      }
    }

    // Interaction
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const tooltip = document.getElementById('tooltip');
    let hovered = null;

    window.addEventListener('pointermove', e=>{
      mouse.x = (e.clientX/innerWidth)*2-1;
      mouse.y = -(e.clientY/innerHeight)*2+1;
      raycaster.setFromCamera(mouse,camera);
      const hits = raycaster.intersectObjects(scene.children,true);
      let found = null;
      let tooltipText = '';
      for(let h of hits){
        const obj = h.object;
        if(obj.userData.type === 'stonehenge' || (obj.parent && obj.parent.userData.type === 'stonehenge')){
          tooltipText = 'Click to roll the Dice of Fate';
          found = stonehenge;
          break;
        }
        if(obj.userData && obj.userData.type === 'fruit'){
          tooltipText = obj.userData.trackTitle;
          found = obj;
          break;
        }
        if(obj.parent && obj.parent.userData && obj.parent.userData.type === 'chest'){
          tooltipText = obj.parent.userData.albumTitle;
          found = obj.parent;
          break;
        }
      }
      if(found !== hovered){
        if(hovered) hovered.scale.set(1,1,1);
        hovered = found;
        if(hovered){
          hovered.scale.set(1.15,1.15,1.15);
          tooltip.textContent = tooltipText;
          tooltip.style.left = (e.clientX+15)+'px';
          tooltip.style.top = (e.clientY+15)+'px';
          tooltip.style.opacity = 1;
        } else tooltip.style.opacity = 0;
      }
    });

    // Player
    const playerBubble = document.getElementById('player-bubble');
    playerBubble.onclick = () => {
      const panel = document.getElementById('album-panel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    };

    function loadTrack(url, title, art) {
      document.getElementById('album-title').textContent = title;
      document.getElementById('album-art').src = art;
      document.getElementById('player-container').innerHTML = `<iframe width="100%" height="450" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${url}&color=%235ab&auto_play=true"></iframe>`;
      document.getElementById('album-panel').style.display = 'block';
      playerBubble.style.display = 'block';
    }

    window.addEventListener('click',()=>{ if(hovered){
      if(hovered.userData.type === 'stonehenge' || (hovered.parent && hovered.parent.userData.type === 'stonehenge')){
        gameMode = true;
        targetRadius = 25;
        targetPhi = Math.PI / 4;
        diceModal.classList.add('active');
        setTimeout(resizeDiceCanvas, 100);
      } else {
        const type = hovered.userData.type;
        const url = hovered.userData.url || hovered.userData.album.playlist;
        const title = type === 'fruit' ? hovered.userData.trackTitle : hovered.userData.albumTitle;
        const art = albums.find(a => a.title === hovered.userData.albumTitle)?.art || '';
        loadTrack(url, title, art);
      }
    }});

    document.querySelectorAll('.close-btn').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        document.getElementById('album-panel').style.display = 'none';
        diceModal.classList.remove('active');
        gameMode = false;
        targetRadius = 70;
        targetPhi = Math.PI / 3.5;
      };
    });

    window.addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      resizeDiceCanvas();
    });

    // Main Animation
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const t = clock.getElapsedTime();

      radius += (targetRadius - radius) * 0.05;
      phi += (targetPhi - phi) * 0.05;
      updateCamera();

      const pulse = 1 + Math.sin(t * 1.2) * 0.04;
      stonehenge.scale.setScalar(pulse);
      aura.material.opacity = 0.2 + Math.sin(t * 1.5) * 0.1;

      renderer.render(scene, camera);
    }
    animate();
  };
</script>
</head>
<body>
<div id="info">
  <strong>п o п c o п f o r m i s t</strong><br>
  <em>The Circle of Destiny v1.0</em><br><br>
  Drag to orbit • Scroll to zoom<br>
  Click Stonehenge → roll the Dice of Fate<br>
  Hover chests/fruits → see titles<br>
  Click to play<br>
  ♪ bubble = toggle player<br>
  <a href="https://ko-fi.com/nnconformist" target="_blank">Tip if it moves you</a>
</div>
<div class="tooltip" id="tooltip"></div>
<div id="cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></div>

<div id="album-panel" class="album-panel">
  <div class="close-btn">×</div>
  <h3 id="album-title"></h3>
  <img id="album-art" width="100%" style="border-radius:12px; margin:16px 0;">
  <div id="player-container"></div>
</div>

<div id="player-bubble">♪</div>

<!-- Dice Game Modal -->
<div id="dice-modal">
  <div class="modal-content">
    <div class="close-btn">×</div>
    <div id="canvas-container"></div>
    <div class="ui-panel">
      <div id="result-display">Roll the dice...</div>
      <button id="roll-btn">ROLL DICE</button>
    </div>
  </div>
</div>
</body>
</html>
